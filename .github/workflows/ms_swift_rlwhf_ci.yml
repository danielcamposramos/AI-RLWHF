name: MS-Swift RLWHF Integration Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'plugins/core/**'
      - 'scripts/data_pipeline/**'
      - 'scripts/training/**'
      - 'tests/integration/**'
      - '.github/workflows/ms_swift_rlwhf_ci.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'plugins/core/**'
      - 'scripts/data_pipeline/**'
      - 'scripts/training/**'
      - 'tests/integration/**'
      - '.github/workflows/ms_swift_rlwhf_ci.yml'

jobs:
  test-cpu:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        # Install CPU version of torch
        pip install torch --index-url https://download.pytorch.org/whl/cpu
        # Install other ms-swift deps, but ms-swift itself is vendored
        pip install -r requirements-ms-swift.txt --extra-index-url https://download.pytorch.org/whl/cpu

    - name: Vendor ms-swift
      run: python scripts/setup/vendor_ms_swift.py

    - name: Run quality gate tests on sample data
      run: |
        python tests/fixtures/sample_honesty_data.py # ensure data exists
        python scripts/data_pipeline/data_quality_gate.py data/test/honesty_logs_sample.jsonl

    - name: Run integration tests on CPU
      run: python -m unittest tests/integration/ms_swift_rlwhf_test.py

  test-gpu:
    # This job is commented out as it requires a self-hosted runner with a GPU.
    # It serves as a template for future implementation.
    # if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    # runs-on: self-hosted-gpu
    runs-on: ubuntu-latest # Placeholder runner
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install GPU dependencies
      run: |
        echo "Skipping GPU test as no GPU runner is available."
        # python -m pip install --upgrade pip
        # pip install -r requirements.txt
        # pip install torch torchvision --index-url https://download.pytorch.org/whl/cu118
        # pip install -r requirements-ms-swift.txt

    - name: Run GPU tests (Skipped)
      run: |
        echo "This step would run tests on a GPU."
        # env:
        #  CUDA_VISIBLE_DEVICES: 0
        # python -m unittest tests/integration/ms_swift_rlwhf_test.py